# üìã RESUMEN COMPLETO DEL BACKEND INVENTARIO MULTI-TENANT

> **Documento t√©cnico para el equipo de Frontend**  
> Contiene toda la informaci√≥n necesaria para integrar con el backend

---

## üöÄ **INICIO R√ÅPIDO**

### **URL Base del Backend**
```
http://localhost:3000
```

### **Comando para Iniciar el Backend**
```bash
cd backend-inventario
npm install
npm run start:dev
```

### **Estado del Backend**
‚úÖ **100% Funcional y Listo para Consumir**

---

## üîê **AUTENTICACI√ìN JWT**

### **Endpoints de Autenticaci√≥n**

#### **Registro de Usuario**
```http
POST /auth/register
Content-Type: application/json

{
  "email": "usuario@ejemplo.com",
  "password": "password123"
}
```

**Respuesta:**
```json
{
  "message": "Usuario registrado correctamente"
}
```

#### **Login de Usuario**
```http
POST /auth/login
Content-Type: application/json

{
  "email": "usuario@ejemplo.com", 
  "password": "password123"
}
```

**Respuesta:**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### **Headers Requeridos para Endpoints Protegidos**
```javascript
{
  'Authorization': 'Bearer <jwt_token>',
  'Content-Type': 'application/json'
}
```

### **Estructura del JWT Payload**
```typescript
{
  sub: string,     // UUID del usuario
  email: string,   // Email del usuario  
  role: string     // 'admin' | 'store'
}
```

---

## üóÇÔ∏è **MODELO DE DATOS**

> **IMPORTANTE:** Todos los IDs son UUID (string), no n√∫meros

### **üë§ Usuario (User)**
```typescript
{
  id: string,              // UUID - Identificador √∫nico
  email: string,           // Email √∫nico para login
  password: string,        // Hash encriptado (no se devuelve en APIs)
  role: string,            // 'admin' | 'store'
  isActive: boolean,       // Estado del usuario
  plan: string | null,     // Plan de suscripci√≥n
  productsUsed: number,    // Contador de productos usados
  lastLogin: Date | null,  // √öltimo acceso
  stores: Store[]          // Tiendas del usuario
}
```

### **üè™ Tienda (Store)**
```typescript
{
  id: string,              // UUID - Identificador √∫nico
  name: string,            // Nombre de la tienda
  isActive: boolean,       // Estado activo/inactivo
  user: User,              // Usuario propietario
  products: Product[],     // Productos de la tienda
  subscriptions: Subscription[] // Suscripciones
}
```

### **üì¶ Producto (Product)**
```typescript
{
  id: string,              // UUID - Identificador √∫nico
  name: string,            // Nombre del producto
  price: number,           // Precio (decimal)
  stock: number,           // Inventario disponible
  category: string | null, // Categor√≠a del producto
  description: string | null, // Descripci√≥n detallada
  image: string | null,    // URL de imagen del producto
  cost: number | null,     // Costo del producto (decimal)
  isActive: boolean,       // Estado activo/inactivo
  unit: string | null,     // Unidad de medida (kg, pcs, etc)
  store: Store             // Tienda propietaria
}
```

### **üí≥ Suscripci√≥n (Subscription)**
```typescript
{
  id: string,              // UUID - Identificador √∫nico
  status: string,          // 'active' | 'inactive' | 'cancelled'
  startDate: Date,         // Fecha de inicio
  endDate: Date | null,    // Fecha de fin (opcional)
  store: Store,            // Tienda asociada
  payments: Payment[]      // Pagos de la suscripci√≥n
}
```

### **üí∞ Pago (Payment)**
```typescript
{
  id: string,              // UUID - Identificador √∫nico
  amount: number,          // Monto del pago (decimal)
  status: string,          // 'pending' | 'paid' | 'failed'
  date: Date,              // Fecha del pago
  subscription: Subscription // Suscripci√≥n asociada
}
```

---

## üõ†Ô∏è **API ENDPOINTS COMPLETOS**

### **üîê Autenticaci√≥n (/auth)**

| M√©todo | Endpoint | Descripci√≥n | Auth |
|--------|----------|-------------|------|
| POST | `/auth/register` | Registro de usuario | No |
| POST | `/auth/login` | Login y obtenci√≥n de JWT | No |

### **üë§ Usuarios (/users) - Solo Admin**

| M√©todo | Endpoint | Descripci√≥n | Roles |
|--------|----------|-------------|-------|
| GET | `/users` | Listar todos los usuarios | admin |
| GET | `/users/:id` | Obtener usuario espec√≠fico | admin |
| PATCH | `/users/:id/active` | Activar/desactivar usuario | admin |

**Body para activar/desactivar usuario:**
```json
{
  "isActive": true
}
```

### **üè™ Tiendas (/stores)**

| M√©todo | Endpoint | Descripci√≥n | Auth |
|--------|----------|-------------|------|
| POST | `/stores` | Crear tienda | JWT |

**Body para crear tienda:**
```json
{
  "name": "Nombre de la Tienda"
}
```

### **üì¶ Productos (/products)**

| M√©todo | Endpoint | Descripci√≥n | Roles |
|--------|----------|-------------|-------|
| GET | `/products` | Listar productos (admin: todos, store: propios) | admin, store |
| GET | `/products/:id` | Obtener producto espec√≠fico | admin, store |
| POST | `/products` | Crear producto | store |
| PUT | `/products/:id` | Actualizar producto completo | store |
| PATCH | `/products/:id/active` | Cambiar estado activo/inactivo | store |
| DELETE | `/products/:id` | Eliminar producto | store |

**DTO para crear/actualizar productos:**
```json
{
  "name": "Producto Ejemplo",
  "price": 29.99,
  "stock": 100,
  "category": "Electr√≥nicos",
  "description": "Descripci√≥n del producto",
  "image": "https://ejemplo.com/imagen.jpg",
  "cost": 15.50,
  "isActive": true,
  "unit": "pcs"
}
```

**Body para cambiar estado:**
```json
{
  "isActive": false
}
```

### **üí≥ Suscripciones (/subscriptions)**

| M√©todo | Endpoint | Descripci√≥n | Roles |
|--------|----------|-------------|-------|
| GET | `/subscriptions` | Listar todas las suscripciones | admin, store |
| GET | `/subscriptions/:id` | Obtener suscripci√≥n espec√≠fica | admin, store |
| POST | `/subscriptions` | Crear nueva suscripci√≥n | admin, store |
| PUT | `/subscriptions/:id` | Actualizar suscripci√≥n | admin, store |
| DELETE | `/subscriptions/:id` | Eliminar suscripci√≥n | admin, store |
| GET | `/subscriptions/:id/payments` | Obtener pagos de suscripci√≥n | admin, store |

**DTO para crear suscripci√≥n:**
```json
{
  "status": "active",
  "startDate": "2025-07-04T00:00:00.000Z",
  "endDate": "2026-07-04T00:00:00.000Z",
  "storeId": "uuid-de-la-tienda"
}
```

### **üí∞ Pagos (/payments)**

| M√©todo | Endpoint | Descripci√≥n | Roles |
|--------|----------|-------------|-------|
| GET | `/payments` | Listar todos los pagos | admin, store |
| GET | `/payments/:id` | Obtener pago espec√≠fico | admin, store |
| POST | `/payments` | Crear nuevo pago | admin, store |
| DELETE | `/payments/:id` | Eliminar pago | admin, store |

**DTO para crear pago:**
```json
{
  "amount": 49.99,
  "status": "paid",
  "date": "2025-07-04T00:00:00.000Z",
  "subscriptionId": 123
}
```

---

## üîí **CONTROL DE ACCESO Y ROLES**

### **Roles Disponibles**
- **`admin`**: Puede ver usuarios, gestionar todo el sistema
- **`store`**: Solo puede gestionar su tienda y productos

### **Protecci√≥n Multi-Tenant**
- Cada usuario `store` solo ve/modifica **SUS** productos
- Los `admin` pueden ver todo pero **NO** modificar productos de tiendas
- Sistema autom√°tico de validaci√≥n de propiedad
- Aislamiento completo entre tiendas

### **Guards Implementados**
- **JwtAuthGuard**: Requiere token JWT v√°lido
- **RolesGuard**: Valida roles espec√≠ficos por endpoint

---

## üìù **VALIDACIONES Y ERRORES**

### **Validaciones Autom√°ticas del Backend**
- **Email**: Formato v√°lido requerido
- **Password**: M√≠nimo 6 caracteres
- **UUIDs**: Validaci√≥n autom√°tica de formato
- **Fechas**: ISO string format requerido
- **N√∫meros**: Validaci√≥n de tipos num√©ricos
- **Campos requeridos**: Validaci√≥n autom√°tica

### **C√≥digos de Error Comunes**

#### **401 - No Autenticado**
```json
{
  "message": "Unauthorized",
  "statusCode": 401
}
```

#### **403 - Sin Permisos**
```json
{
  "message": "No tienes permisos para acceder a este recurso",
  "statusCode": 403
}
```

#### **404 - No Encontrado**
```json
{
  "message": "Recurso no encontrado",
  "statusCode": 404
}
```

#### **409 - Conflicto (Email Duplicado)**
```json
{
  "message": "El email ya est√° registrado",
  "statusCode": 409
}
```

#### **400 - Error de Validaci√≥n**
```json
{
  "message": [
    "email must be an email",
    "password must be longer than or equal to 6 characters"
  ],
  "error": "Bad Request",
  "statusCode": 400
}
```

---

## üí° **EJEMPLOS DE IMPLEMENTACI√ìN FRONTEND**

### **üîê Flujo de Autenticaci√≥n**

```javascript
// 1. Funci√≥n de Login
const login = async (email, password) => {
  try {
    const response = await fetch('http://localhost:3000/auth/login', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ email, password })
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.message);
    }

    const { access_token } = await response.json();
    
    // Guardar token
    localStorage.setItem('token', access_token);
    
    return access_token;
  } catch (error) {
    console.error('Error en login:', error);
    throw error;
  }
};

// 2. Funci√≥n helper para requests autenticados
const authenticatedFetch = async (url, options = {}) => {
  const token = localStorage.getItem('token');
  
  return fetch(url, {
    ...options,
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
      ...options.headers
    }
  });
};
```

### **üì¶ Gesti√≥n de Productos**

```javascript
// Listar productos
const getProducts = async () => {
  const response = await authenticatedFetch('http://localhost:3000/products');
  
  if (!response.ok) {
    throw new Error('Error al obtener productos');
  }
  
  return response.json();
};

// Crear producto (ACTUALIZADO)
const createProduct = async (productData) => {
  // PASO 1: Primero obtenemos las tiendas del usuario
  const storesResponse = await authenticatedFetch('http://localhost:3000/stores');
  const stores = await storesResponse.json();
  
  if (stores.length === 0) {
    throw new Error('El usuario no tiene tiendas. Debe crear una tienda primero');
  }
  
  // PASO 2: Usamos el ID de la primera tienda (o permitimos al usuario elegir)
  const storeId = productData.storeId || stores[0].id;
  
  // PASO 3: Creamos el producto especificando la tienda
  const response = await authenticatedFetch('http://localhost:3000/products', {
    method: 'POST',
    body: JSON.stringify({
      name: productData.name,
      price: parseFloat(productData.price),
      stock: parseInt(productData.stock),
      category: productData.category,
      description: productData.description,
      image: productData.image,
      cost: productData.cost ? parseFloat(productData.cost) : null,
      unit: productData.unit,
      storeId: storeId // ¬°IMPORTANTE! Siempre enviar el ID de la tienda
    })
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.message);
  }
  
  return response.json();
};

// Actualizar producto
const updateProduct = async (productId, productData) => {
  const response = await authenticatedFetch(`http://localhost:3000/products/${productId}`, {
    method: 'PUT',
    body: JSON.stringify(productData)
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.message);
  }
  
  return response.json();
};

// Eliminar producto
const deleteProduct = async (productId) => {
  const response = await authenticatedFetch(`http://localhost:3000/products/${productId}`, {
    method: 'DELETE'
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.message);
  }
  
  return response.json();
};
```

### **üè™ Crear Tienda**

```javascript
const createStore = async (storeName) => {
  const response = await authenticatedFetch('http://localhost:3000/stores', {
    method: 'POST',
    body: JSON.stringify({ name: storeName })
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.message);
  }
  
  return response.json();
};
```

### **üë§ Gesti√≥n de Usuarios (Solo Admin)**

```javascript
// Listar usuarios
const getUsers = async () => {
  const response = await authenticatedFetch('http://localhost:3000/users');
  
  if (!response.ok) {
    throw new Error('Error al obtener usuarios');
  }
  
  return response.json();
};

// Activar/Desactivar usuario
const toggleUserActive = async (userId, isActive) => {
  const response = await authenticatedFetch(`http://localhost:3000/users/${userId}/active`, {
    method: 'PATCH',
    body: JSON.stringify({ isActive })
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.message);
  }
  
  return response.json();
};
```

---

## ‚ö†Ô∏è **PUNTOS CR√çTICOS PARA EL FRONTEND**

### **‚úÖ LO QUE YA EST√Å HECHO EN EL BACKEND (NO DUPLICAR)**
1. ‚úÖ **Autenticaci√≥n JWT completa**
2. ‚úÖ **Validaciones de datos y DTOs**
3. ‚úÖ **Control de roles y permisos**
4. ‚úÖ **Protecci√≥n multi-tenant autom√°tica**
5. ‚úÖ **Encriptaci√≥n de passwords**
6. ‚úÖ **Manejo de errores est√°ndar**
7. ‚úÖ **CORS habilitado para desarrollo**
8. ‚úÖ **Base de datos con UUID**

### **üö® LO QUE DEBE MANEJAR EL FRONTEND**
1. **Almacenar y gestionar JWT tokens**
2. **Manejar estados de loading/error/success en UI**
3. **Validaciones de UI adicionales (UX)**
4. **Navegaci√≥n condicional basada en roles**
5. **Refresh autom√°tico de datos tras operaciones**
6. **Logout y limpieza de tokens**
7. **Manejo de expiraci√≥n de tokens**

### **üìã FLUJOS RECOMENDADOS PARA EL FRONTEND**

#### **Flujo de Autenticaci√≥n**
1. Login ‚Üí Guardar token ‚Üí Redirect seg√∫n rol
2. Admin ‚Üí Dashboard de usuarios y estad√≠sticas
3. Store ‚Üí Dashboard de productos y tienda

#### **Flujo Multi-Tenant**
1. Usuario Store ‚Üí Solo ve SUS productos
2. Crear tienda ‚Üí Asociar autom√°ticamente al usuario
3. Productos ‚Üí Filtrados autom√°ticamente por tienda

#### **Gesti√≥n de Estados**
```javascript
// Ejemplo con React Context o Redux
const AuthContext = {
  user: { id: 'uuid', email: 'user@test.com', role: 'store' },
  token: 'jwt_token',
  isAuthenticated: true,
  isAdmin: false,
  isStore: true
};
```

---

## üè¢ **MODELO MULTI-TENANT**

### **Estructura de Datos**

El sistema utiliza un modelo multi-tenant donde:

1. **Usuario (User)**: Representa a un usuario del sistema
2. **Tienda (Store)**: Cada usuario puede tener m√∫ltiples tiendas
3. **Producto (Product)**: Los productos pertenecen a una tienda espec√≠fica

```
Usuario 1 ‚îÄ‚î¨‚îÄ Tienda A ‚îÄ‚î¨‚îÄ Producto 1
           ‚îÇ            ‚îú‚îÄ Producto 2
           ‚îÇ            ‚îî‚îÄ Producto 3
           ‚îÇ
           ‚îî‚îÄ Tienda B ‚îÄ‚î¨‚îÄ Producto 4
                        ‚îî‚îÄ Producto 5

Usuario 2 ‚îÄ‚îÄ‚îÄ Tienda C ‚îÄ‚î¨‚îÄ Producto 6
                        ‚îî‚îÄ Producto 7
```

### **‚ö†Ô∏è Importante: Relaci√≥n entre entidades**

Cuando se crea un producto, **siempre** debe especificarse la tienda a la que pertenece mediante el campo `storeId`. Este debe ser un ID v√°lido de una tienda que pertenezca al usuario autenticado.

**Error com√∫n:** Enviar el ID del usuario como `storeId`. Estos son entidades diferentes.

### **Flujo recomendado para crear productos**

1. Al iniciar sesi√≥n, obtener el token JWT
2. Realizar una petici√≥n a `/stores` para obtener las tiendas del usuario
3. Guardar los IDs de las tiendas para usarlos al crear productos
4. Al crear un producto, especificar el `storeId` de una de estas tiendas

```typescript
// Pseudo-c√≥digo del flujo correcto
const login = async () => {
  const { token, user } = await loginUser();
  localStorage.setItem('token', token);
  localStorage.setItem('userId', user.id);
  
  // Inmediatamente despu√©s de login, obtener las tiendas
  const stores = await fetchStores();
  localStorage.setItem('stores', JSON.stringify(stores));
  
  // Si no hay tiendas, redirigir a crear una
  if (stores.length === 0) {
    redirectTo('/create-store');
  }
};

const createProduct = () => {
  const stores = JSON.parse(localStorage.getItem('stores'));
  
  // Mostrar selector de tiendas al usuario
  const selectedStoreId = showStoreSelector(stores);
  
  // Crear producto con la tienda seleccionada
  return createProductAPI({
    name: "Producto de ejemplo",
    price: 99.99,
    stock: 100,
    storeId: selectedStoreId // ID correcto de la tienda
  });
};
```

### **Diagrama de Entidad-Relaci√≥n**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           ‚îÇ       ‚îÇ           ‚îÇ       ‚îÇ           ‚îÇ
‚îÇ   User    ‚îÇ1     *‚îÇ   Store   ‚îÇ1     *‚îÇ  Product  ‚îÇ
‚îÇ           ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§           ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üèóÔ∏è **TECNOLOG√çAS DEL BACKEND**

### **Stack T√©cnico**
- **Framework**: NestJS v11.0.1
- **Base de Datos**: PostgreSQL (Supabase)
- **ORM**: TypeORM v0.3.25
- **Autenticaci√≥n**: JWT + Passport
- **Validaci√≥n**: class-validator + class-transformer
- **Testing**: Jest + Supertest
- **Encriptaci√≥n**: bcryptjs

### **Configuraci√≥n de Base de Datos**
- **Host**: Supabase Cloud (aws-0-us-east-2.pooler.supabase.com)
- **SSL**: Habilitado y configurado
- **Synchronize**: true (solo desarrollo)
- **UUIDs**: Generaci√≥n autom√°tica para todos los IDs

---

## üß™ **TESTING**

### **Tests E2E Disponibles**
- ‚úÖ Suite completa de tests para suscripciones
- ‚úÖ Validaci√≥n del flujo multi-tenant
- ‚úÖ Tests de autenticaci√≥n y autorizaci√≥n
- ‚úÖ Validaci√≥n de endpoints protegidos

### **Comandos de Testing**
```bash
# Tests end-to-end
npm run test:e2e

# Tests unitarios
npm run test

# Tests en modo watch
npm run test:watch

# Coverage report
npm run test:cov
```

---

## üöÄ **ESTADO ACTUAL DEL BACKEND**

### **‚úÖ COMPLETAMENTE FUNCIONAL**
- ‚úÖ Sistema de autenticaci√≥n JWT robusto
- ‚úÖ Control de roles y permisos granular
- ‚úÖ CRUD completo para todas las entidades
- ‚úÖ Protecci√≥n multi-tenant autom√°tica
- ‚úÖ Validaciones exhaustivas con DTOs
- ‚úÖ Base de datos estable con UUID
- ‚úÖ Tests E2E pasando al 100%
- ‚úÖ Conexi√≥n segura a Supabase
- ‚úÖ Documentaci√≥n completa

### **üéØ LISTO PARA INTEGRACI√ìN**

El backend est√° **100% operativo** y listo para ser consumido por el frontend. Solo necesitas:

1. **Iniciar el backend**: `npm run start:dev`
2. **Implementar el cliente HTTP** con las funciones de ejemplo
3. **Manejar tokens JWT** en localStorage/sessionStorage
4. **Crear interfaces de usuario** seg√∫n los roles
5. **Implementar navegaci√≥n condicional** basada en permisos

### **üìû SOPORTE**

Si encuentras alg√∫n problema durante la integraci√≥n:
1. Verifica que el backend est√© corriendo en `http://localhost:3000`
2. Revisa los logs del backend para errores espec√≠ficos
3. Valida que los headers de autorizaci√≥n est√©n correctos
4. Confirma que los datos enviados cumplan con los DTOs

---

**üéâ ¬°El backend est√° completamente preparado para soportar tu aplicaci√≥n frontend!**

---

*Documento actualizado: 4 de julio de 2025*  
*Backend Version: 0.0.1*  
*Estado: Producci√≥n Ready*
